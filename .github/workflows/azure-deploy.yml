name: Deploy Azure Watchdog (Bicep)

on:
  push:
    branches:
      - main       # run every time main is updated

permissions:
  contents: read   # required by actions/checkout

env:
  AZURE_LOCATION: ${{ secrets.LOCATION }}   # e.g. canadaeast

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # ────────────────────────── 1. Source  ──────────────────────────
    - name: Checkout repository
      uses: actions/checkout@v4

    # ────────────────────────── 2. Login  ───────────────────────────
    - name: Azure CLI login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}   # SP JSON from `az ad sp create-for-rbac …`

    # ────────────────────────── 3a. Validate  ───────────────────────
    - name: Validate Bicep (subscription-scope)
      run: |
        az deployment sub validate \
          --name watchdog-validate-${{ github.run_number }} \
          --location "$AZURE_LOCATION" \
          --template-file main.bicep \
          --parameters \
              location="$AZURE_LOCATION" \
              adminPassword="${{ secrets.VM_PASSWORD }}"

    # ────────────────────────── 3b. Deploy  ─────────────────────────
    - name: Deploy Bicep (subscription-scope)
      uses: azure/arm-deploy@v2
      with:
        scope: subscription
        region: ${{ env.AZURE_LOCATION }}
        template: ./main.bicep
        parameters: |
          location=${{ env.AZURE_LOCATION }}
          adminPassword=${{ secrets.VM_PASSWORD }}
        failOnStdErr: false   # warnings (if any) won’t fail the job
    # ─────────── 4. Logout ───────────
    - name: Logout
      run: az logout



